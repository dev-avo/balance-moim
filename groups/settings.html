<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì„ ì„¤ì • - ë°¸ëŸ°ìŠ¤ ëª¨ì„</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header" id="header"></header>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <main class="page">
    <div class="container">
      <div class="page-content">
        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingState" class="text-center p-xl">
          <div class="loading-spinner"></div>
        </div>

        <!-- ì„¤ì • ë‚´ìš© -->
        <div class="hidden" id="settingsContent">
          <div class="flex items-center gap-md mb-xl">
            <a href="#" class="btn btn-ghost btn-sm" id="backBtn">â† ëŒì•„ê°€ê¸°</a>
            <h1 class="text-3xl font-bold">ëª¨ì„ ì„¤ì •</h1>
          </div>

          <!-- ê¸°ë³¸ ì •ë³´ ìˆ˜ì • -->
          <section class="card mb-lg">
            <h2 class="text-lg font-semibold mb-md">ğŸ“ ê¸°ë³¸ ì •ë³´</h2>
            <form id="updateGroupForm">
              <div class="form-group">
                <label class="form-label">ëª¨ì„ ì´ë¦„ *</label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="groupName"
                  placeholder="ëª¨ì„ ì´ë¦„"
                  maxlength="30"
                  required
                >
                <p class="text-sm text-secondary mt-xs">ìµœëŒ€ 30ì</p>
              </div>

              <div class="form-group">
                <label class="form-label">ëª¨ì„ ì„¤ëª…</label>
                <textarea 
                  class="form-textarea" 
                  id="groupDescription"
                  placeholder="ëª¨ì„ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…"
                  maxlength="200"
                  rows="3"
                ></textarea>
                <p class="text-sm text-secondary mt-xs">ìµœëŒ€ 200ì</p>
              </div>

              <button type="submit" class="btn btn-primary" id="updateBtn">
                ì €ì¥í•˜ê¸°
              </button>
            </form>
          </section>

          <!-- ë©¤ë²„ ê´€ë¦¬ -->
          <section class="card mb-lg">
            <h2 class="text-lg font-semibold mb-md">ğŸ‘¥ ë©¤ë²„ ê´€ë¦¬</h2>
            <p class="text-secondary text-sm mb-md">
              ëª¨ì„ ë©¤ë²„: <span id="memberCount">0</span>ëª…
            </p>
            <div id="membersList" class="members-list">
              <p class="text-secondary text-sm">ë¡œë”© ì¤‘...</p>
            </div>
          </section>

          <!-- ì´ˆëŒ€ ë§í¬ -->
          <section class="card mb-lg">
            <h2 class="text-lg font-semibold mb-md">ğŸ”— ì´ˆëŒ€ ë§í¬</h2>
            <p class="text-secondary text-sm mb-md">
              ìƒˆë¡œìš´ ë©¤ë²„ë¥¼ ì´ˆëŒ€í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
            </p>
            <button class="btn btn-secondary" id="copyInviteBtn">
              ğŸ“‹ ì´ˆëŒ€ ë§í¬ ë³µì‚¬
            </button>
          </section>

          <!-- ìœ„í—˜ êµ¬ì—­ -->
          <section class="card danger-zone">
            <h2 class="text-lg font-semibold mb-md text-danger">âš ï¸ ìœ„í—˜ êµ¬ì—­</h2>
            <p class="text-secondary text-sm mb-md">
              ëª¨ì„ì„ ì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ì„ ë‚´ ì§ˆë¬¸ì€ ìœ ì§€ë˜ì§€ë§Œ ëª¨ì„ ì „ìš© ì„¤ì •ì´ í•´ì œë©ë‹ˆë‹¤.
            </p>
            <button class="btn btn-danger" id="deleteGroupBtn">
              ëª¨ì„ ì‚­ì œí•˜ê¸°
            </button>
          </section>
        </div>

        <!-- ì—ëŸ¬ ìƒíƒœ -->
        <div class="card text-center hidden" id="errorState">
          <div class="empty-state-icon">ğŸ˜¢</div>
          <h3 class="empty-state-title">ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <a href="/groups.html" class="btn btn-primary mt-lg">
            ëª¨ì„ ëª©ë¡ìœ¼ë¡œ
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- ì¶”ê°€ ìŠ¤íƒ€ì¼ -->
  <style>
    .members-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md);
      background-color: var(--color-bg);
      border-radius: var(--radius-md);
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .member-name {
      font-weight: 500;
    }

    .member-badge {
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: 500;
      background-color: rgba(0, 113, 227, 0.1);
      color: var(--color-accent);
    }

    .danger-zone {
      border: 1px solid var(--color-danger);
    }

    .btn-danger {
      background-color: var(--color-danger);
      color: white;
    }

    .btn-danger:hover {
      background-color: #c82333;
    }
  </style>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { initHeader } from '/js/components/Header.js';
    import { requireAuth, getCurrentUser } from '/js/utils/auth.js';
    import { groupAPI } from '/js/services/api.js';
    import { toastSuccess, toastError } from '/js/components/Toast.js';
    import { confirmModal } from '/js/components/Modal.js';
    import { setButtonLoading } from '/js/components/Loading.js';
    import { copyToClipboard } from '/js/utils/clipboard.js';

    let groupId = null;
    let groupData = null;

    async function init() {
      await initHeader();
      
      const isAuth = await requireAuth();
      if (!isAuth) return;
      
      // URLì—ì„œ ê·¸ë£¹ ID ê°€ì ¸ì˜¤ê¸°
      const params = new URLSearchParams(window.location.search);
      groupId = params.get('id');
      
      if (!groupId) {
        showError();
        return;
      }
      
      await loadGroupSettings();
      bindEvents();
    }

    async function loadGroupSettings() {
      const loadingState = document.getElementById('loadingState');
      const settingsContent = document.getElementById('settingsContent');
      
      try {
        const response = await groupAPI.getDetail(groupId);
        groupData = response.data?.group;
        
        if (!groupData) {
          showError();
          return;
        }
        
        // ê´€ë¦¬ì í™•ì¸
        const user = getCurrentUser();
        if (!user || groupData.creator_id !== user.id) {
          showError();
          return;
        }
        
        renderSettings(groupData);
        loadingState.classList.add('hidden');
        settingsContent.classList.remove('hidden');
        
      } catch (error) {
        console.error('ëª¨ì„ ë¡œë“œ ì‹¤íŒ¨:', error);
        showError();
      }
    }

    function renderSettings(group) {
      document.getElementById('groupName').value = group.name || '';
      document.getElementById('groupDescription').value = group.description || '';
      document.getElementById('memberCount').textContent = group.memberCount || 0;
      document.getElementById('backBtn').href = `/groups/detail.html?id=${groupId}`;
      
      // ë©¤ë²„ ëª©ë¡ ë Œë”ë§
      const membersList = document.getElementById('membersList');
      const members = group.members || [];
      const user = getCurrentUser();
      
      if (members.length === 0) {
        membersList.innerHTML = '<p class="text-secondary text-sm">ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      
      membersList.innerHTML = members.map(member => `
        <div class="member-item">
          <div class="member-info">
            <span class="member-name">${escapeHtml(member.display_name)}</span>
            ${member.user_id === group.creator_id ? '<span class="member-badge">ê´€ë¦¬ì</span>' : ''}
          </div>
          ${member.user_id !== user.id && member.user_id !== group.creator_id ? `
            <button class="btn btn-ghost btn-sm text-danger" onclick="removeMember('${member.user_id}', '${escapeHtml(member.display_name)}')">
              ì¶”ë°©
            </button>
          ` : ''}
        </div>
      `).join('');
    }

    function bindEvents() {
      // ëª¨ì„ ìˆ˜ì •
      document.getElementById('updateGroupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('groupName').value.trim();
        const description = document.getElementById('groupDescription').value.trim();
        
        if (!name) {
          toastError('ëª¨ì„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        const btn = document.getElementById('updateBtn');
        setButtonLoading(btn, true);
        
        try {
          await groupAPI.update(groupId, { name, description });
          toastSuccess('ëª¨ì„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
          console.error('ëª¨ì„ ìˆ˜ì • ì‹¤íŒ¨:', error);
          toastError(error.message || 'ëª¨ì„ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          setButtonLoading(btn, false);
        }
      });
      
      // ì´ˆëŒ€ ë§í¬ ë³µì‚¬
      document.getElementById('copyInviteBtn').addEventListener('click', async () => {
        try {
          const response = await groupAPI.createInvite(groupId);
          const inviteCode = response.data?.inviteCode;
          const inviteUrl = `${window.location.origin}/invite.html?code=${inviteCode}`;
          
          // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹œë„
          const copySuccess = await copyToClipboard(inviteUrl);
          
          if (copySuccess) {
            toastSuccess('ì´ˆëŒ€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
          } else {
            // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ë§í¬ í‘œì‹œ
            prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', inviteUrl);
          }
        } catch (error) {
          console.error('ì´ˆëŒ€ ë§í¬ ìƒì„± ì‹¤íŒ¨:', error);
          toastError('ì´ˆëŒ€ ë§í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
      
      // ëª¨ì„ ì‚­ì œ
      document.getElementById('deleteGroupBtn').addEventListener('click', async () => {
        const confirmed = await confirmModal(
          'ëª¨ì„ ì‚­ì œ',
          `ì •ë§ "${groupData?.name}" ëª¨ì„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
        );
        
        if (!confirmed) return;
        
        try {
          await groupAPI.delete(groupId);
          toastSuccess('ëª¨ì„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          setTimeout(() => {
            window.location.href = '/groups.html';
          }, 1000);
        } catch (error) {
          console.error('ëª¨ì„ ì‚­ì œ ì‹¤íŒ¨:', error);
          toastError(error.message || 'ëª¨ì„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }

    // ë©¤ë²„ ì¶”ë°©
    window.removeMember = async function(userId, userName) {
      const confirmed = await confirmModal(
        'ë©¤ë²„ ì¶”ë°©',
        `ì •ë§ "${userName}"ë‹˜ì„ ëª¨ì„ì—ì„œ ì¶”ë°©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
      );
      
      if (!confirmed) return;
      
      try {
        await groupAPI.removeMember(groupId, userId);
        toastSuccess('ë©¤ë²„ê°€ ì¶”ë°©ë˜ì—ˆìŠµë‹ˆë‹¤.');
        await loadGroupSettings();
      } catch (error) {
        console.error('ë©¤ë²„ ì¶”ë°© ì‹¤íŒ¨:', error);
        toastError(error.message || 'ë©¤ë²„ ì¶”ë°©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    };

    function showError() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    init();
  </script>
</body>
</html>

