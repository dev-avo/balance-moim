<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì„ ìƒì„¸ - ë°¸ëŸ°ìŠ¤ ëª¨ì„</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header" id="header"></header>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <main class="page">
    <div class="container">
      <div class="page-content">
        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingState" class="text-center p-xl">
          <div class="loading-spinner"></div>
        </div>

        <!-- ëª¨ì„ ìƒì„¸ ë‚´ìš© -->
        <div class="hidden" id="groupContent">
          <!-- ëª¨ì„ í—¤ë” -->
          <div class="flex justify-between items-start mb-xl">
            <div>
              <h1 class="text-3xl font-bold" id="groupName"></h1>
              <p class="text-secondary mt-sm" id="groupDescription"></p>
            </div>
            <a href="#" class="btn btn-secondary btn-sm hidden" id="settingsBtn">
              âš™ï¸ ì„¤ì •
            </a>
            <a href="/home.html" class="btn btn-primary btn-sm hidden" id="startBtn">
              ğŸš€ ë°”ë¡œ ì‹œì‘
            </a>
          </div>

          <!-- ëª¨ì„ í†µê³„ -->
          <section class="card mb-lg">
            <h2 class="text-lg font-semibold mb-md">ğŸ“Š ëª¨ì„ í†µê³„</h2>
            <div class="flex gap-xl">
              <div>
                <span class="text-2xl font-bold" id="memberCount">0</span>
                <span class="text-secondary text-sm">ëª…</span>
              </div>
              <div>
                <span class="text-2xl font-bold" id="questionCount">0</span>
                <span class="text-secondary text-sm">ê°œ ì§ˆë¬¸</span>
              </div>
            </div>
            
            <div class="flex gap-sm mt-lg flex-wrap">
              <a href="#" class="btn btn-primary btn-sm hidden" id="playGroupBtn">
                ğŸ¯ ëª¨ì„ ì „ìš© ì§ˆë¬¸ ì‹œì‘
              </a>
              <button class="btn btn-secondary btn-sm" id="copyInviteBtn">
                ğŸ“‹ ì´ˆëŒ€ ë§í¬ ë³µì‚¬
              </button>
            </div>
          </section>

          <!-- ì·¨í–¥ ìœ ì‚¬ë„ -->
          <section class="card mb-lg">
            <h2 class="text-lg font-semibold mb-md">ğŸ† ë‚˜ì™€ ê°€ì¥ ë¹„ìŠ·í•œ ì‚¬ëŒ</h2>
            <div id="similarityList" class="similarity-list scrollable-list">
              <p class="text-secondary text-sm">ë¡œë”© ì¤‘...</p>
            </div>
            <button class="btn btn-ghost btn-sm mt-md hidden" id="loadMoreSimilarity">
              ë”ë³´ê¸°
            </button>
          </section>

          <!-- ëª¨ì„ ì‘ë‹µ -->
          <section class="card mb-lg">
            <h2 class="text-lg font-semibold mb-md">ğŸ“‹ ëª¨ì„ ì‘ë‹µ</h2>
            <div id="responsesList" class="scrollable-list">
              <p class="text-secondary text-sm">ë¡œë”© ì¤‘...</p>
            </div>
            <button class="btn btn-ghost btn-sm mt-md hidden" id="loadMoreResponses">
              ë”ë³´ê¸°
            </button>
          </section>

          <!-- ëª¨ì„ ë‚˜ê°€ê¸° -->
          <div class="mt-xl">
            <button class="btn btn-ghost btn-sm" id="leaveGroupBtn" style="color: var(--color-danger);">
              ëª¨ì„ ë‚˜ê°€ê¸°
            </button>
          </div>
        </div>

        <!-- ì—ëŸ¬ ìƒíƒœ -->
        <div class="card text-center hidden" id="errorState">
          <div class="empty-state-icon">ğŸ˜¢</div>
          <h3 class="empty-state-title">ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
          <a href="/groups.html" class="btn btn-primary mt-lg">
            ëª¨ì„ ëª©ë¡ìœ¼ë¡œ
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- ì‚¬ìš©ì ë¹„êµ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="compareModal">
    <div class="modal compare-modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ” ì·¨í–¥ ë¹„êµ</h3>
        <button class="modal-close" id="closeCompareModal">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="4" x2="16" y2="16"></line>
            <line x1="16" y1="4" x2="4" y2="16"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="compareModalBody">
        <div class="text-center p-lg">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‘ë‹µ ìƒì„¸ ëª¨ë‹¬ (ì„ íƒì§€ë³„ ë©¤ë²„ ëª©ë¡) -->
  <div class="modal-overlay" id="responseMembersModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ‘¥ ì‘ë‹µ ìƒì„¸</h3>
        <button class="modal-close" id="closeResponseMembersModal">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="4" x2="16" y2="16"></line>
            <line x1="16" y1="4" x2="4" y2="16"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="responseMembersModalBody">
        <div class="text-center p-lg">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì¶”ê°€ ìŠ¤íƒ€ì¼ -->
  <style>
    .similarity-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .scrollable-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .similarity-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background-color: var(--color-bg);
      border-radius: var(--radius-md);
      border: 1px solid transparent;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .similarity-item:hover {
      background: linear-gradient(135deg, rgba(0, 113, 227, 0.05), rgba(52, 199, 89, 0.05));
      border-color: var(--color-accent);
    }

    .similarity-rank {
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--color-accent);
      width: 32px;
    }

    .similarity-info {
      flex: 1;
    }

    .similarity-name {
      font-weight: 500;
    }

    .similarity-rate {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .response-item {
      padding: var(--spacing-md);
      background-color: var(--color-bg);
      border-radius: var(--radius-md);
      border: 1px solid transparent;
      margin-bottom: var(--spacing-sm);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .response-item:hover {
      background: linear-gradient(135deg, rgba(0, 113, 227, 0.05), rgba(52, 199, 89, 0.05));
      border-color: var(--color-accent);
    }

    .response-question {
      font-weight: 500;
      margin-bottom: var(--spacing-sm);
    }

    .response-item .stats-labels {
      color: var(--color-text-secondary);
    }

    /* ë¹„êµ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .compare-summary {
      text-align: center;
      padding: var(--spacing-lg);
      background-color: var(--color-bg);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      flex-shrink: 0;
    }

    .compare-user-name {
      font-size: var(--font-size-lg);
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .compare-match-rate {
      font-size: var(--font-size-3xl);
      font-weight: 700;
      color: var(--color-accent);
    }

    /* ì·¨í–¥ë¹„êµ ëª¨ë‹¬: summary ê³ ì •, listë§Œ ìŠ¤í¬ë¡¤ */
    .compare-modal .modal-body {
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
    }

    .compare-list {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
    }

    .compare-load-more {
      flex-shrink: 0;
      padding-top: var(--spacing-md);
    }

    .compare-item {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--color-border);
    }

    .compare-item:last-child {
      border-bottom: none;
    }

    .compare-question {
      font-weight: 500;
      margin-bottom: var(--spacing-sm);
    }

    .compare-choices {
      display: flex;
      gap: var(--spacing-md);
      font-size: var(--font-size-sm);
    }

    .compare-choice {
      flex: 1;
      padding: var(--spacing-sm);
      border-radius: var(--radius-sm);
      text-align: center;
    }

    .compare-choice.mine {
      background-color: rgba(0, 113, 227, 0.1);
      border: 1px solid var(--color-accent);
    }

    .compare-choice.theirs {
      background-color: rgba(142, 142, 147, 0.1);
      border: 1px solid var(--color-text-tertiary);
    }

    .compare-choice.match {
      background-color: rgba(52, 199, 89, 0.1);
      border: 1px solid var(--color-success);
    }

    .compare-choice-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      margin-bottom: 2px;
    }

    /* ì‘ë‹µ ë©¤ë²„ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    #responseMembersModal .modal-body {
      display: flex;
      flex-direction: column;
    }

    .response-modal-question {
      font-size: var(--font-size-lg);
      font-weight: 600;
      text-align: center;
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-md);
      background-color: var(--color-bg);
      border-radius: var(--radius-md);
      flex-shrink: 0;
    }

    .response-options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
      align-items: stretch;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
    }

    .response-option-section {
      background-color: var(--color-bg);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      display: flex;
      flex-direction: column;
    }

    .response-option-section.option-a {
      border-top: 3px solid var(--color-accent);
    }

    .response-option-section.option-b {
      border-top: 3px solid var(--color-success);
    }

    .response-option-header {
      margin-bottom: var(--spacing-sm);
    }

    .response-option-text {
      font-weight: 600;
      font-size: var(--font-size-sm);
      line-height: 1.4;
      margin-bottom: var(--spacing-xs);
      word-break: keep-all;
    }

    .response-option-count {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .response-member-list-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .response-member-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .response-member-item {
      padding: var(--spacing-sm);
      font-size: var(--font-size-sm);
      border-bottom: 1px solid var(--color-border-light);
    }

    .response-member-item:last-child {
      border-bottom: none;
    }

    .response-empty-message {
      color: var(--color-text-tertiary);
      font-size: var(--font-size-sm);
      text-align: center;
      padding: var(--spacing-md);
    }

    @media (max-width: 480px) {
      .response-options-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { initHeader } from '/js/components/Header.js';
    import { requireAuth, getCurrentUser } from '/js/utils/auth.js';
    import { groupAPI } from '/js/services/api.js';
    import { toastSuccess, toastError } from '/js/components/Toast.js';
    import { confirmModal } from '/js/components/Modal.js';
    import { copyWithFallbackPrompt } from '/js/utils/clipboard.js';

    let groupId = null;
    let groupData = null;
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ
    let allSimilarities = [];
    let similarityDisplayCount = 10;
    let allResponses = [];
    let responsesDisplayCount = 10;

    async function init() {
      await initHeader();
      
      const isAuth = await requireAuth();
      if (!isAuth) return;
      
      // URLì—ì„œ ê·¸ë£¹ ID ê°€ì ¸ì˜¤ê¸°
      const params = new URLSearchParams(window.location.search);
      groupId = params.get('id');
      
      if (!groupId) {
        showError();
        return;
      }
      
      await loadGroupDetail();
      bindEvents();
    }

    async function loadGroupDetail() {
      const loadingState = document.getElementById('loadingState');
      const groupContent = document.getElementById('groupContent');
      
      try {
        const response = await groupAPI.getDetail(groupId);
        groupData = response.data?.group;
        
        if (!groupData) {
          showError();
          return;
        }
        
        renderGroupDetail(groupData);
        loadingState.classList.add('hidden');
        groupContent.classList.remove('hidden');
        
        // ìœ ì‚¬ë„ ë¡œë“œ
        loadSimilarity();
        
        // ì‘ë‹µ ë¡œë“œ
        loadResponses();
        
      } catch (error) {
        console.error('ëª¨ì„ ë¡œë“œ ì‹¤íŒ¨:', error);
        showError();
      }
    }

    function renderGroupDetail(group) {
      document.getElementById('groupName').textContent = group.name;
      document.getElementById('groupDescription').textContent = group.description || '';
      document.getElementById('memberCount').textContent = group.memberCount || 0;
      document.getElementById('questionCount').textContent = group.questionCount || 0;
      
      const user = getCurrentUser();
      const params = new URLSearchParams(window.location.search);
      const fromInvite = params.get('from') === 'invite';
      
      // ê´€ë¦¬ìì¸ ê²½ìš° ì„¤ì • ë²„íŠ¼ í‘œì‹œ
      if (user && group.creator_id === user.id) {
        const settingsBtn = document.getElementById('settingsBtn');
        settingsBtn.classList.remove('hidden');
        settingsBtn.href = `/groups/settings.html?id=${groupId}`;
      } else if (fromInvite) {
        // ì´ˆëŒ€ë¡œ ë“¤ì–´ì˜¨ ì‚¬ìš©ìì—ê²Œ ë°”ë¡œ ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
        const startBtn = document.getElementById('startBtn');
        startBtn.classList.remove('hidden');
      }
      
      // ëª¨ì„ ì „ìš© ì§ˆë¬¸ì´ ìˆìœ¼ë©´ í”Œë ˆì´ ë²„íŠ¼ í‘œì‹œ
      if (group.questionCount > 0) {
        const playBtn = document.getElementById('playGroupBtn');
        playBtn.classList.remove('hidden');
        playBtn.href = `/groups/play.html?id=${groupId}`;
      }
    }

    async function loadSimilarity() {
      const container = document.getElementById('similarityList');
      const loadMoreBtn = document.getElementById('loadMoreSimilarity');
      
      try {
        const response = await groupAPI.getSimilarity(groupId);
        allSimilarities = response.data?.similarities || [];
        
        if (allSimilarities.length === 0) {
          container.innerHTML = '<p class="text-secondary text-sm">ì•„ì§ ë¹„êµí•  ë°ì´í„°ê°€ ì—†ì–´ìš”.</p>';
          return;
        }
        
        renderSimilarities();
        
      } catch (error) {
        console.error('ìœ ì‚¬ë„ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = '<p class="text-secondary text-sm">ìœ ì‚¬ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    function renderSimilarities() {
      const container = document.getElementById('similarityList');
      const loadMoreBtn = document.getElementById('loadMoreSimilarity');
      
      // ìƒìœ„ 5ëª…ë§Œ ë³´ì—¬ì£¼ê¸° (ìš”ì²­ì‚¬í•­)
      const displayItems = allSimilarities.slice(0, Math.min(5, similarityDisplayCount));
      
      container.innerHTML = displayItems.map((item, index) => `
        <div class="similarity-item" onclick="showCompare('${item.userId}')">
          <span class="similarity-rank">${index + 1}</span>
          <div class="similarity-info">
            <div class="similarity-name">${escapeHtml(item.displayName)}</div>
            <div class="similarity-rate">${item.matchRate}% ì¼ì¹˜ (${item.matchCount}/${item.commonCount}ê°œ)</div>
          </div>
          <span class="text-secondary">â†’</span>
        </div>
      `).join('');
      
      // ë”ë³´ê¸° ë²„íŠ¼ì€ ìœ ì‚¬ë„ì˜ ê²½ìš° 5ëª… ì´í•˜ë¡œ ì œí•œë˜ì–´ ìˆìœ¼ë¯€ë¡œ ìˆ¨ê¹€
      loadMoreBtn.classList.add('hidden');
    }

    async function loadResponses() {
      const container = document.getElementById('responsesList');
      
      try {
        const response = await groupAPI.getResponses(groupId);
        allResponses = response.data?.responses || [];
        
        if (allResponses.length === 0) {
          container.innerHTML = '<p class="text-secondary text-sm">ì•„ì§ ì‘ë‹µì´ ì—†ì–´ìš”.</p>';
          return;
        }
        
        renderResponses();
        
      } catch (error) {
        console.error('ì‘ë‹µ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = '<p class="text-secondary text-sm">ì‘ë‹µì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    function renderResponses() {
      const container = document.getElementById('responsesList');
      const loadMoreBtn = document.getElementById('loadMoreResponses');
      
      const displayItems = allResponses.slice(0, responsesDisplayCount);
      
      container.innerHTML = displayItems.map(item => `
        <div class="response-item" onclick="showResponseMembers('${item.id}')">
          <div class="response-question">${escapeHtml(item.title)}</div>
          <div class="stats-bar" style="height: 32px; font-size: 13px;">
            <div class="stats-bar-a" style="width: ${item.optionA.percentage}%">${item.optionA.percentage > 0 ? item.optionA.percentage + '%' : ''}</div>
            <div class="stats-bar-b" style="width: ${item.optionB.percentage}%">${item.optionB.percentage > 0 ? item.optionB.percentage + '%' : ''}</div>
          </div>
          <div class="stats-labels flex justify-between mt-sm">
            <span class="text-sm">${escapeHtml(item.optionA.text)} (${item.optionA.count}ëª…)</span>
            <span class="text-sm">${escapeHtml(item.optionB.text)} (${item.optionB.count}ëª…)</span>
          </div>
        </div>
      `).join('');
      
      // ë” í‘œì‹œí•  í•­ëª©ì´ ìˆìœ¼ë©´ ë²„íŠ¼ í‘œì‹œ
      if (responsesDisplayCount < allResponses.length) {
        loadMoreBtn.classList.remove('hidden');
      } else {
        loadMoreBtn.classList.add('hidden');
      }
    }

    // ì‘ë‹µ ë©¤ë²„ ëª¨ë‹¬ ìƒíƒœ
    let responseMembersData = null;
    let optionADisplayCount = 20;
    let optionBDisplayCount = 20;
    
    // ì‘ë‹µ ë©¤ë²„ ëª¨ë‹¬ í‘œì‹œ
    window.showResponseMembers = async function(questionId) {
      const modal = document.getElementById('responseMembersModal');
      const body = document.getElementById('responseMembersModalBody');
      
      modal.classList.add('open');
      body.innerHTML = '<div class="text-center p-lg"><div class="loading-spinner"></div></div>';
      
      // ì´ˆê¸°í™”
      optionADisplayCount = 20;
      optionBDisplayCount = 20;
      
      try {
        const response = await groupAPI.getQuestionMembers(groupId, questionId);
        responseMembersData = response.data;
        
        if (!responseMembersData) {
          body.innerHTML = `
            <div class="text-center p-lg">
              <p class="text-secondary">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          `;
          return;
        }
        
        renderResponseMembersModal();
        
      } catch (error) {
        console.error('ì‘ë‹µ ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨:', error);
        body.innerHTML = `
          <div class="text-center p-lg">
            <p class="text-danger">ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
          </div>
        `;
      }
    };
    
    // ì‘ë‹µ ë©¤ë²„ ëª¨ë‹¬ ë Œë”ë§
    function renderResponseMembersModal() {
      const body = document.getElementById('responseMembersModalBody');
      const { question, optionAMembers, optionBMembers } = responseMembersData;
      
      const displayA = optionAMembers.slice(0, optionADisplayCount);
      const displayB = optionBMembers.slice(0, optionBDisplayCount);
      const hasMoreA = optionADisplayCount < optionAMembers.length;
      const hasMoreB = optionBDisplayCount < optionBMembers.length;
      
      body.innerHTML = `
        <div class="response-modal-question">${escapeHtml(question.title)}</div>
        <div class="response-options-grid">
          <div class="response-option-section option-a">
            <div class="response-option-header">
              <div class="response-option-text">${escapeHtml(question.optionA)}</div>
              <div class="response-option-count">${optionAMembers.length}ëª…</div>
            </div>
            <div class="response-member-list-wrapper">
              <div class="response-member-list" id="optionAMemberList">
                ${displayA.length > 0 
                  ? displayA.map(m => `
                      <div class="response-member-item">${escapeHtml(m.displayName)}</div>
                    `).join('')
                  : '<div class="response-empty-message">ì•„ì§ ì—†ì–´ìš”</div>'
                }
              </div>
              ${hasMoreA ? `
                <button class="btn btn-ghost btn-sm mt-sm w-full" onclick="loadMoreOptionA()">
                  ë”ë³´ê¸° (${displayA.length}/${optionAMembers.length})
                </button>
              ` : ''}
            </div>
          </div>
          <div class="response-option-section option-b">
            <div class="response-option-header">
              <div class="response-option-text">${escapeHtml(question.optionB)}</div>
              <div class="response-option-count">${optionBMembers.length}ëª…</div>
            </div>
            <div class="response-member-list-wrapper">
              <div class="response-member-list" id="optionBMemberList">
                ${displayB.length > 0 
                  ? displayB.map(m => `
                      <div class="response-member-item">${escapeHtml(m.displayName)}</div>
                    `).join('')
                  : '<div class="response-empty-message">ì•„ì§ ì—†ì–´ìš”</div>'
                }
              </div>
              ${hasMoreB ? `
                <button class="btn btn-ghost btn-sm mt-sm w-full" onclick="loadMoreOptionB()">
                  ë”ë³´ê¸° (${displayB.length}/${optionBMembers.length})
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }
    
    // ì„ íƒì§€ A ë©¤ë²„ ë”ë³´ê¸°
    window.loadMoreOptionA = function() {
      optionADisplayCount += 20;
      renderResponseMembersModal();
    };
    
    // ì„ íƒì§€ B ë©¤ë²„ ë”ë³´ê¸°
    window.loadMoreOptionB = function() {
      optionBDisplayCount += 20;
      renderResponseMembersModal();
    };

    // ë¹„êµ ëª¨ë‹¬ ìƒíƒœ
    let currentCompareData = null;
    let compareDisplayCount = 10;
    
    // ì‚¬ìš©ì ë¹„êµ ëª¨ë‹¬ í‘œì‹œ
    window.showCompare = async function(userId) {
      const modal = document.getElementById('compareModal');
      const body = document.getElementById('compareModalBody');
      
      modal.classList.add('open');
      body.innerHTML = '<div class="text-center p-lg"><div class="loading-spinner"></div></div>';
      compareDisplayCount = 10; // ì´ˆê¸°í™”
      
      try {
        const response = await groupAPI.getCompare(groupId, userId);
        currentCompareData = response.data;
        
        if (!currentCompareData || currentCompareData.comparisons.length === 0) {
          body.innerHTML = `
            <div class="text-center p-lg">
              <p class="text-secondary">ê³µí†µìœ¼ë¡œ ì‘ë‹µí•œ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          `;
          return;
        }
        
        renderCompareModal();
        
      } catch (error) {
        console.error('ë¹„êµ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        body.innerHTML = `
          <div class="text-center p-lg">
            <p class="text-danger">ë¹„êµ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
          </div>
        `;
      }
    };
    
    function renderCompareModal() {
      const body = document.getElementById('compareModalBody');
      const data = currentCompareData;
      const displayItems = data.comparisons.slice(0, compareDisplayCount);
      const hasMore = compareDisplayCount < data.comparisons.length;
      
      body.innerHTML = `
        <div class="compare-summary">
          <div class="compare-user-name">${escapeHtml(data.targetUser.displayName)}ë‹˜ê³¼</div>
          <div class="compare-match-rate">${data.summary.matchRate}%</div>
          <div class="text-secondary text-sm">ì·¨í–¥ ì¼ì¹˜ (${data.summary.matchCount}/${data.summary.commonCount}ê°œ)</div>
        </div>
        <div class="compare-list">
          ${displayItems.map(item => `
            <div class="compare-item">
              <div class="compare-question">${escapeHtml(item.title)}</div>
              <div class="compare-choices">
                <div class="compare-choice ${item.isMatch ? 'match' : 'mine'}">
                  <div class="compare-choice-label">ë‚˜</div>
                  <div>${item.myChoice === 'A' ? escapeHtml(item.optionA) : escapeHtml(item.optionB)}</div>
                </div>
                <div class="compare-choice ${item.isMatch ? 'match' : 'theirs'}">
                  <div class="compare-choice-label">${escapeHtml(data.targetUser.displayName)}</div>
                  <div>${item.theirChoice === 'A' ? escapeHtml(item.optionA) : escapeHtml(item.optionB)}</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
        ${hasMore ? `
          <div class="compare-load-more">
            <button class="btn btn-ghost btn-sm w-full" onclick="loadMoreCompare()">
              ë”ë³´ê¸° (${displayItems.length}/${data.comparisons.length})
            </button>
          </div>
        ` : ''}
      `;
    }
    
    window.loadMoreCompare = function() {
      compareDisplayCount += 10;
      renderCompareModal();
    };

    function bindEvents() {
      // ë¹„êµ ëª¨ë‹¬ ë‹«ê¸°
      document.getElementById('closeCompareModal').addEventListener('click', () => {
        document.getElementById('compareModal').classList.remove('open');
      });
      
      document.getElementById('compareModal').addEventListener('click', (e) => {
        if (e.target.id === 'compareModal') {
          document.getElementById('compareModal').classList.remove('open');
        }
      });
      
      // ì‘ë‹µ ë©¤ë²„ ëª¨ë‹¬ ë‹«ê¸°
      document.getElementById('closeResponseMembersModal').addEventListener('click', () => {
        document.getElementById('responseMembersModal').classList.remove('open');
      });
      
      document.getElementById('responseMembersModal').addEventListener('click', (e) => {
        if (e.target.id === 'responseMembersModal') {
          document.getElementById('responseMembersModal').classList.remove('open');
        }
      });
      
      // ëª¨ì„ ì‘ë‹µ ë”ë³´ê¸°
      document.getElementById('loadMoreResponses').addEventListener('click', () => {
        responsesDisplayCount += 10;
        renderResponses();
      });

      // ì´ˆëŒ€ ë§í¬ ë³µì‚¬
      document.getElementById('copyInviteBtn').addEventListener('click', async () => {
        try {
          const response = await groupAPI.createInvite(groupId);
          const inviteCode = response.data?.inviteCode;
          const inviteUrl = `${window.location.origin}/invite.html?code=${inviteCode}`;
          
          // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹œë„ (ì‹¤íŒ¨ ì‹œ prompt ìë™ í‘œì‹œ)
          const copySuccess = await copyWithFallbackPrompt(inviteUrl, 'ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:');
          
          if (copySuccess) {
            toastSuccess('ì´ˆëŒ€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
          }
        } catch (error) {
          console.error('ì´ˆëŒ€ ë§í¬ ìƒì„± ì‹¤íŒ¨:', error);
          toastError('ì´ˆëŒ€ ë§í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
      
      // ëª¨ì„ ë‚˜ê°€ê¸°
      document.getElementById('leaveGroupBtn').addEventListener('click', async () => {
        const confirmed = await confirmModal(
          'ëª¨ì„ ë‚˜ê°€ê¸°',
          'ì •ë§ ì´ ëª¨ì„ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì‘ë‹µ ê¸°ë¡ì€ ìœ ì§€ë©ë‹ˆë‹¤.'
        );
        
        if (!confirmed) return;
        
        try {
          await groupAPI.leave(groupId);
          toastSuccess('ëª¨ì„ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.');
          setTimeout(() => {
            window.location.href = '/groups.html';
          }, 1000);
        } catch (error) {
          console.error('ëª¨ì„ ë‚˜ê°€ê¸° ì‹¤íŒ¨:', error);
          toastError(error.message || 'ëª¨ì„ ë‚˜ê°€ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }

    function showError() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    init();
  </script>
</body>
</html>
