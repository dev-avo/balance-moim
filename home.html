<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”Œë ˆì´ - ë°¸ëŸ°ìŠ¤ ëª¨ì„</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header" id="header"></header>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <main class="page">
    <div class="container">
      <!-- ì£¼ì˜ì‚¬í•­ ëª¨ë‹¬ (ì²« ë°©ë¬¸ ì‹œ) -->
      <div class="modal-overlay" id="warningModal">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
          </div>
          <div class="modal-body">
            <p>â€¢ í•œ ë²ˆ ì„ íƒí•œ ë‹µë³€ì€ <strong>ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong></p>
            <p class="mt-sm">â€¢ ì‹ ì¤‘í•˜ê²Œ ì„ íƒí•´ì£¼ì„¸ìš”!</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" id="startGameBtn">ì‹œì‘í•˜ê¸°</button>
          </div>
        </div>
      </div>

      <!-- ë¡œë”© ìƒíƒœ -->
      <div class="game-loading" id="loadingState">
        <div class="loading-spinner"></div>
        <p class="text-secondary mt-md">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <!-- ê²Œì„ í™”ë©´ -->
      <section class="game-container hidden" id="gameContainer">
        <!-- íƒœê·¸ í•„í„° -->
        <div class="tag-filter-section mb-lg" id="tagFilterSection">
          <div class="flex items-center gap-sm mb-sm">
            <span class="text-sm text-secondary">ğŸ·ï¸ íƒœê·¸ í•„í„°:</span>
            <button class="btn btn-ghost btn-sm" id="clearTagsBtn" style="display: none;">
              ì „ì²´ ë³´ê¸°
            </button>
          </div>
          <div class="tag-filter-list" id="tagFilterList">
            <div class="loading-spinner" style="width: 20px; height: 20px;"></div>
          </div>
        </div>

        <!-- ì§ˆë¬¸ ì¹´ë“œ -->
        <div class="question-card card fade-in" id="questionCard">
          <div class="question-tags tag-list mb-md" id="questionTags"></div>
          <h2 class="question-title" id="questionTitle"></h2>
          
          <div class="choice-container mt-xl" id="choiceContainer">
            <button class="choice-btn option-a" id="optionA" data-option="A"></button>
            <button class="choice-btn option-b" id="optionB" data-option="B"></button>
          </div>
        </div>

        <!-- ê²°ê³¼ ì¹´ë“œ (ì„ íƒ í›„) -->
        <div class="result-card card hidden slide-up" id="resultCard">
          <h3 class="result-title mb-lg">ê²°ê³¼</h3>
          
          <!-- ì „ì²´ í†µê³„ -->
          <div class="result-section">
            <h4 class="text-sm text-secondary mb-sm">ì „ì²´ í†µê³„</h4>
            <div class="stats-bar" id="totalStats">
              <div class="stats-bar-a" id="totalStatsA"></div>
              <div class="stats-bar-b" id="totalStatsB"></div>
            </div>
            <div class="stats-labels flex justify-between mt-sm">
              <span class="text-sm" id="totalLabelA"></span>
              <span class="text-sm" id="totalLabelB"></span>
            </div>
          </div>

          <!-- ëª¨ì„ë³„ í†µê³„ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ) -->
          <div class="result-section mt-xl hidden" id="groupStatsSection">
            <h4 class="text-sm text-secondary mb-md">ëª¨ì„ë³„ í†µê³„</h4>
            <div id="groupStatsList"></div>
          </div>

          <!-- ë‹¤ìŒ ì§ˆë¬¸ ë²„íŠ¼ -->
          <div class="mt-xl text-center">
            <button class="btn btn-primary btn-lg" id="nextQuestionBtn">
              ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ â†’
            </button>
          </div>
        </div>

        <!-- ì§ˆë¬¸ ì—†ìŒ ìƒíƒœ -->
        <div class="empty-state hidden" id="emptyState">
          <div class="empty-state-icon">ğŸ‰</div>
          <h3 class="empty-state-title">ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€í–ˆì–´ìš”!</h3>
          <p class="empty-state-description">
            ìƒˆë¡œìš´ ì§ˆë¬¸ì´ ì˜¬ë¼ì˜¤ë©´ ì•Œë ¤ë“œë¦´ê²Œìš”.
          </p>
          <button class="btn btn-secondary mt-lg" id="createQuestionBtn">
            ì§ì ‘ ì§ˆë¬¸ ë§Œë“¤ê¸°
          </button>
        </div>
      </section>
    </div>
  </main>

  <!-- ì¶”ê°€ ìŠ¤íƒ€ì¼ -->
  <style>
    .game-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
    }

    .game-container {
      padding: var(--spacing-xl) 0;
    }

    .question-card {
      text-align: center;
      padding: var(--spacing-2xl);
    }

    .question-title {
      font-size: var(--font-size-2xl);
      font-weight: 600;
      line-height: 1.3;
    }

    .result-card {
      padding: var(--spacing-xl);
    }

    .result-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
      text-align: center;
    }

    .group-stats-item {
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-md);
      background-color: var(--color-bg);
      border-radius: var(--radius-md);
    }

    .group-stats-name {
      font-weight: 500;
      margin-bottom: var(--spacing-sm);
    }

    .group-stats-bar {
      height: 24px;
      font-size: var(--font-size-xs);
    }

    /* íƒœê·¸ í•„í„° ìŠ¤íƒ€ì¼ */
    .tag-filter-section {
      padding: var(--spacing-md);
      background-color: var(--color-bg-secondary);
      border-radius: var(--radius-lg);
    }

    .tag-filter-list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
    }

    .tag-filter-chip {
      padding: var(--spacing-xs) var(--spacing-sm);
      background-color: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .tag-filter-chip:hover {
      border-color: var(--color-accent);
    }

    .tag-filter-chip.active {
      background-color: var(--color-accent);
      border-color: var(--color-accent);
      color: white;
    }
  </style>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { initHeader } from '/js/components/Header.js';
    import { checkSession, isLoggedIn } from '/js/utils/auth.js';
    import { questionAPI, responseAPI, tagAPI } from '/js/services/api.js';
    import { toastError, toastSuccess } from '/js/components/Toast.js';

    // ìƒíƒœ
    let currentQuestion = null;
    let hasAnswered = false;
    let selectedTags = [];
    let allTags = [];

    // í˜ì´ì§€ ì´ˆê¸°í™”
    async function init() {
      await initHeader();
      await checkSession();
      
      // íƒœê·¸ ëª©ë¡ ë¡œë“œ
      loadTags();
      
      // ì²« ë°©ë¬¸ ì²´í¬
      const hasSeenWarning = localStorage.getItem('balance_warning_seen');
      const warningModal = document.getElementById('warningModal');
      
      if (!hasSeenWarning) {
        warningModal.classList.add('open');
      } else {
        warningModal.classList.remove('open');
        await loadQuestion();
      }
      
      // ì‹œì‘í•˜ê¸° ë²„íŠ¼
      document.getElementById('startGameBtn').addEventListener('click', () => {
        localStorage.setItem('balance_warning_seen', 'true');
        warningModal.classList.remove('open');
        loadQuestion();
      });
      
      // ì„ íƒì§€ ë²„íŠ¼
      document.getElementById('optionA').addEventListener('click', () => selectOption('A'));
      document.getElementById('optionB').addEventListener('click', () => selectOption('B'));
      
      // ë‹¤ìŒ ì§ˆë¬¸ ë²„íŠ¼
      document.getElementById('nextQuestionBtn').addEventListener('click', () => {
        loadQuestion();
      });
      
      // ì§ˆë¬¸ ë§Œë“¤ê¸° ë²„íŠ¼
      document.getElementById('createQuestionBtn').addEventListener('click', () => {
        window.location.href = '/questions/create.html';
      });
      
      // íƒœê·¸ í•„í„° ì´ˆê¸°í™” ë²„íŠ¼
      document.getElementById('clearTagsBtn').addEventListener('click', () => {
        selectedTags = [];
        renderTagFilters();
        loadQuestion();
      });
    }

    // íƒœê·¸ ëª©ë¡ ë¡œë“œ
    async function loadTags() {
      const container = document.getElementById('tagFilterList');
      
      try {
        const response = await tagAPI.getAll();
        allTags = response.data?.tags || [];
        renderTagFilters();
      } catch (error) {
        console.error('íƒœê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = '<span class="text-secondary text-sm">íƒœê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</span>';
      }
    }

    // íƒœê·¸ í•„í„° ë Œë”ë§
    function renderTagFilters() {
      const container = document.getElementById('tagFilterList');
      const clearBtn = document.getElementById('clearTagsBtn');
      
      if (allTags.length === 0) {
        container.innerHTML = '<span class="text-secondary text-sm">íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
        return;
      }
      
      // ìƒìœ„ 10ê°œ íƒœê·¸ë§Œ í‘œì‹œ
      const topTags = allTags.slice(0, 10);
      
      container.innerHTML = topTags.map(tag => `
        <span class="tag-filter-chip ${selectedTags.includes(tag.name) ? 'active' : ''}" 
              data-tag="${tag.name}"
              onclick="toggleTag('${tag.name}')">
          #${tag.name}
        </span>
      `).join('');
      
      // ì „ì²´ ë³´ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
      clearBtn.style.display = selectedTags.length > 0 ? 'inline-flex' : 'none';
    }

    // íƒœê·¸ í† ê¸€
    window.toggleTag = function(tagName) {
      const index = selectedTags.indexOf(tagName);
      if (index > -1) {
        selectedTags.splice(index, 1);
      } else {
        selectedTags.push(tagName);
      }
      renderTagFilters();
      loadQuestion();
    };

    // ì§ˆë¬¸ ë¡œë“œ
    async function loadQuestion() {
      const loadingState = document.getElementById('loadingState');
      const gameContainer = document.getElementById('gameContainer');
      const questionCard = document.getElementById('questionCard');
      const resultCard = document.getElementById('resultCard');
      const emptyState = document.getElementById('emptyState');
      
      // ì´ˆê¸°í™”
      loadingState.classList.remove('hidden');
      gameContainer.classList.add('hidden');
      resultCard.classList.add('hidden');
      emptyState.classList.add('hidden');
      hasAnswered = false;
      
      try {
        const response = await questionAPI.getRandom(selectedTags);
        
        loadingState.classList.add('hidden');
        gameContainer.classList.remove('hidden');
        
        if (!response.data?.question) {
          // ì§ˆë¬¸ ì—†ìŒ
          questionCard.classList.add('hidden');
          emptyState.classList.remove('hidden');
          return;
        }
        
        currentQuestion = response.data.question;
        renderQuestion(currentQuestion);
        questionCard.classList.remove('hidden');
        
      } catch (error) {
        console.error('ì§ˆë¬¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        loadingState.classList.add('hidden');
        gameContainer.classList.remove('hidden');
        toastError('ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì§ˆë¬¸ ë Œë”ë§
    function renderQuestion(question) {
      const tagsEl = document.getElementById('questionTags');
      const titleEl = document.getElementById('questionTitle');
      const optionAEl = document.getElementById('optionA');
      const optionBEl = document.getElementById('optionB');
      
      // íƒœê·¸
      tagsEl.innerHTML = (question.tags || [])
        .map(tag => `<span class="tag">#${tag}</span>`)
        .join('');
      
      // ì§ˆë¬¸ ì œëª©
      titleEl.textContent = question.title;
      
      // ì„ íƒì§€
      optionAEl.textContent = question.option_a;
      optionBEl.textContent = question.option_b;
      
      // ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
      optionAEl.classList.remove('selected');
      optionBEl.classList.remove('selected');
      optionAEl.disabled = false;
      optionBEl.disabled = false;
    }

    // ì„ íƒì§€ ì„ íƒ
    async function selectOption(option) {
      if (hasAnswered || !currentQuestion) return;
      hasAnswered = true;
      
      const optionAEl = document.getElementById('optionA');
      const optionBEl = document.getElementById('optionB');
      
      // ì„ íƒ í‘œì‹œ
      if (option === 'A') {
        optionAEl.classList.add('selected');
      } else {
        optionBEl.classList.add('selected');
      }
      
      // ë²„íŠ¼ ë¹„í™œì„±í™”
      optionAEl.disabled = true;
      optionBEl.disabled = true;
      
      try {
        // ì‘ë‹µ ì œì¶œ
        await responseAPI.submit(currentQuestion.id, option);
        
        // í†µê³„ ë¡œë“œ
        const statsResponse = await questionAPI.getStats(currentQuestion.id);
        showResults(statsResponse.data, option);
        
      } catch (error) {
        console.error('ì‘ë‹µ ì œì¶œ ì‹¤íŒ¨:', error);
        // ì´ë¯¸ ì‘ë‹µí•œ ê²½ìš°ì—ë„ í†µê³„ëŠ” ë³´ì—¬ì¤Œ
        try {
          const statsResponse = await questionAPI.getStats(currentQuestion.id);
          showResults(statsResponse.data, option);
        } catch {
          toastError('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }
    }

    // ê²°ê³¼ í‘œì‹œ
    function showResults(stats, selectedOption) {
      const resultCard = document.getElementById('resultCard');
      const questionCard = document.getElementById('questionCard');
      
      // ì „ì²´ í†µê³„
      const total = stats.total || { optionA: { percentage: 50 }, optionB: { percentage: 50 } };
      
      document.getElementById('totalStatsA').style.width = `${total.optionA.percentage}%`;
      document.getElementById('totalStatsB').style.width = `${total.optionB.percentage}%`;
      document.getElementById('totalStatsA').textContent = `${total.optionA.percentage}%`;
      document.getElementById('totalStatsB').textContent = `${total.optionB.percentage}%`;
      document.getElementById('totalLabelA').textContent = `${currentQuestion.option_a} (${total.optionA.count || 0}ëª…)`;
      document.getElementById('totalLabelB').textContent = `${currentQuestion.option_b} (${total.optionB.count || 0}ëª…)`;
      
      // ëª¨ì„ë³„ í†µê³„ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ)
      const groupSection = document.getElementById('groupStatsSection');
      const groupList = document.getElementById('groupStatsList');
      
      if (stats.groups && stats.groups.length > 0) {
        groupSection.classList.remove('hidden');
        groupList.innerHTML = stats.groups.map(group => `
          <div class="group-stats-item">
            <div class="group-stats-name">${group.groupName}</div>
            <div class="stats-bar group-stats-bar">
              <div class="stats-bar-a" style="width: ${group.optionA.percentage}%">${group.optionA.percentage}%</div>
              <div class="stats-bar-b" style="width: ${group.optionB.percentage}%">${group.optionB.percentage}%</div>
            </div>
          </div>
        `).join('');
      } else {
        groupSection.classList.add('hidden');
      }
      
      // ê²°ê³¼ ì¹´ë“œ í‘œì‹œ
      resultCard.classList.remove('hidden');
      resultCard.scrollIntoView({ behavior: 'smooth' });
    }

    init();
  </script>
</body>
</html>
