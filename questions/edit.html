<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì§ˆë¬¸ í¸ì§‘ - ë°¸ëŸ°ìŠ¤ ëª¨ì„</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header" id="header"></header>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <main class="page">
    <div class="container">
      <div class="page-content">
        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingState" class="text-center p-xl">
          <div class="loading-spinner"></div>
        </div>

        <!-- í¸ì§‘ í¼ -->
        <div class="hidden" id="editContent">
          <div class="flex items-center gap-md mb-xl">
            <a href="/questions/my.html" class="btn btn-ghost btn-sm">â† ëŒì•„ê°€ê¸°</a>
            <h1 class="text-3xl font-bold">ì§ˆë¬¸ í¸ì§‘</h1>
          </div>

          <div class="card">
            <form id="editQuestionForm">
              <!-- ì§ˆë¬¸ ì œëª© -->
              <div class="form-group">
                <label class="form-label">ì§ˆë¬¸ ì œëª© *</label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="questionTitle"
                  placeholder="ì˜ˆ: ë” ë§›ìˆëŠ” ì§„ë¼ë©´ì€?"
                  maxlength="100"
                  required
                >
                <p class="text-sm text-secondary mt-xs">ìµœëŒ€ 100ì</p>
              </div>

              <!-- ì„ íƒì§€ A -->
              <div class="form-group">
                <label class="form-label">ì„ íƒì§€ A *</label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="optionA"
                  placeholder="ì˜ˆ: ë§¤ìš´ë§›"
                  maxlength="50"
                  required
                >
              </div>

              <!-- ì„ íƒì§€ B -->
              <div class="form-group">
                <label class="form-label">ì„ íƒì§€ B *</label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="optionB"
                  placeholder="ì˜ˆ: ìˆœí•œë§›"
                  maxlength="50"
                  required
                >
              </div>

              <!-- íƒœê·¸ (ì½ê¸° ì „ìš©) -->
              <div class="form-group">
                <label class="form-label">íƒœê·¸</label>
                <div class="tag-list" id="tagList"></div>
                <p class="text-sm text-secondary mt-xs">íƒœê·¸ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>

              <!-- ê³µê°œ ì„¤ì • -->
              <div class="form-group">
                <label class="form-label">ê³µê°œ ì„¤ì •</label>
                
                <label class="flex items-center gap-sm mb-sm">
                  <input type="radio" name="visibility" value="public">
                  <span>ì „ì²´ ê³µê°œ</span>
                  <span class="text-secondary text-sm">- ëª¨ë“  ì‚¬ìš©ìê°€ ë³¼ ìˆ˜ ìˆìŒ</span>
                </label>
                
                <label class="flex items-center gap-sm mb-sm">
                  <input type="radio" name="visibility" value="group" disabled>
                  <span>ëª¨ì„ ì „ìš©</span>
                  <span class="text-secondary text-sm">- ê³µê°œ ì„¤ì •ì—ì„œ ë³€ê²½ ë¶ˆê°€</span>
                </label>
                
                <label class="flex items-center gap-sm">
                  <input type="radio" name="visibility" value="private">
                  <span>ë¹„ê³µê°œ</span>
                  <span class="text-secondary text-sm">- ë‚˜ë§Œ ë³¼ ìˆ˜ ìˆìŒ</span>
                </label>
              </div>

              <!-- í†µê³„ ì •ë³´ -->
              <div class="form-group">
                <label class="form-label">ì‘ë‹µ í†µê³„</label>
                <div class="stats-info" id="statsInfo">
                  <p class="text-secondary text-sm">ë¡œë”© ì¤‘...</p>
                </div>
              </div>

              <div class="flex gap-md mt-xl">
                <button type="button" class="btn btn-secondary" onclick="history.back()">
                  ì·¨ì†Œ
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                  ì €ì¥í•˜ê¸°
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- ì—ëŸ¬ ìƒíƒœ -->
        <div class="card text-center hidden" id="errorState">
          <div class="empty-state-icon">ğŸ˜¢</div>
          <h3 class="empty-state-title">ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <a href="/questions/my.html" class="btn btn-primary mt-lg">
            ë‚´ ì§ˆë¬¸ ëª©ë¡ìœ¼ë¡œ
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- ì¶”ê°€ ìŠ¤íƒ€ì¼ -->
  <style>
    .stats-info {
      padding: var(--spacing-md);
      background-color: var(--color-bg);
      border-radius: var(--radius-md);
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm) 0;
    }

    .stats-row + .stats-row {
      border-top: 1px solid var(--color-border);
    }

    .selected-tag {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      background-color: var(--color-accent);
      color: white;
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      margin-right: var(--spacing-xs);
      margin-bottom: var(--spacing-xs);
    }
  </style>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { initHeader } from '/js/components/Header.js';
    import { requireAuth, getCurrentUser } from '/js/utils/auth.js';
    import { questionAPI } from '/js/services/api.js';
    import { toastSuccess, toastError } from '/js/components/Toast.js';
    import { setButtonLoading } from '/js/components/Loading.js';

    let questionId = null;
    let questionData = null;

    async function init() {
      await initHeader();
      
      const isAuth = await requireAuth();
      if (!isAuth) return;
      
      // URLì—ì„œ ì§ˆë¬¸ ID ê°€ì ¸ì˜¤ê¸°
      const params = new URLSearchParams(window.location.search);
      questionId = params.get('id');
      
      if (!questionId) {
        showError();
        return;
      }
      
      await loadQuestion();
      bindEvents();
    }

    async function loadQuestion() {
      const loadingState = document.getElementById('loadingState');
      const editContent = document.getElementById('editContent');
      
      try {
        const response = await questionAPI.getDetail(questionId);
        questionData = response.data?.question;
        
        if (!questionData) {
          showError();
          return;
        }
        
        // ì†Œìœ ì í™•ì¸
        const user = getCurrentUser();
        if (!user || questionData.creator_id !== user.id) {
          showError();
          return;
        }
        
        renderQuestion(questionData);
        loadingState.classList.add('hidden');
        editContent.classList.remove('hidden');
        
        // í†µê³„ ë¡œë“œ
        loadStats();
        
      } catch (error) {
        console.error('ì§ˆë¬¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        showError();
      }
    }

    function renderQuestion(question) {
      document.getElementById('questionTitle').value = question.title || '';
      document.getElementById('optionA').value = question.option_a || '';
      document.getElementById('optionB').value = question.option_b || '';
      
      // ê³µê°œ ì„¤ì •
      const visibilityRadio = document.querySelector(`input[name="visibility"][value="${question.visibility}"]`);
      if (visibilityRadio) {
        visibilityRadio.checked = true;
      }
      
      // íƒœê·¸
      const tagList = document.getElementById('tagList');
      const tags = question.tags || [];
      tagList.innerHTML = tags.map(tag => `
        <span class="selected-tag">#${escapeHtml(tag)}</span>
      `).join('') || '<span class="text-secondary text-sm">íƒœê·¸ ì—†ìŒ</span>';
    }

    async function loadStats() {
      const container = document.getElementById('statsInfo');
      
      try {
        const response = await questionAPI.getStats(questionId);
        const stats = response.data?.total;
        
        if (!stats || stats.totalCount === 0) {
          container.innerHTML = '<p class="text-secondary text-sm">ì•„ì§ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = `
          <div class="stats-row">
            <span>ì´ ì‘ë‹µ</span>
            <span class="font-semibold">${stats.totalCount}ëª…</span>
          </div>
          <div class="stats-row">
            <span>${escapeHtml(questionData.option_a)}</span>
            <span class="font-semibold">${stats.optionA.percentage}% (${stats.optionA.count}ëª…)</span>
          </div>
          <div class="stats-row">
            <span>${escapeHtml(questionData.option_b)}</span>
            <span class="font-semibold">${stats.optionB.percentage}% (${stats.optionB.count}ëª…)</span>
          </div>
        `;
        
      } catch (error) {
        console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = '<p class="text-secondary text-sm">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    function bindEvents() {
      document.getElementById('editQuestionForm').addEventListener('submit', handleSubmit);
    }

    async function handleSubmit(e) {
      e.preventDefault();
      
      const title = document.getElementById('questionTitle').value.trim();
      const optionA = document.getElementById('optionA').value.trim();
      const optionB = document.getElementById('optionB').value.trim();
      const visibility = document.querySelector('input[name="visibility"]:checked')?.value;
      
      // ê²€ì¦
      if (!title || !optionA || !optionB) {
        toastError('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ëª¨ì„ ì „ìš©ì€ ë³€ê²½ ë¶ˆê°€
      if (visibility === 'group') {
        toastError('ëª¨ì„ ì „ìš© ì„¤ì •ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const btn = document.getElementById('submitBtn');
      setButtonLoading(btn, true);
      
      try {
        await questionAPI.update(questionId, {
          title,
          optionA,
          optionB,
          visibility,
        });
        
        toastSuccess('ì§ˆë¬¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        
        setTimeout(() => {
          window.location.href = '/questions/my.html';
        }, 1000);
        
      } catch (error) {
        console.error('ì§ˆë¬¸ ìˆ˜ì • ì‹¤íŒ¨:', error);
        toastError(error.message || 'ì§ˆë¬¸ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        setButtonLoading(btn, false);
      }
    }

    function showError() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    init();
  </script>
</body>
</html>

