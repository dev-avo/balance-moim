<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„¤ì • - ë°¸ëŸ°ìŠ¤ ëª¨ì„</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header" id="header"></header>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <main class="page">
    <div class="container">
      <div class="page-content">
        <h1 class="text-3xl font-bold mb-xl">ì„¤ì •</h1>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingState" class="text-center p-xl">
          <div class="loading-spinner"></div>
        </div>

        <!-- í…Œë§ˆ ì„¤ì • (ë¡œê·¸ì¸ ì—†ì´ë„ í‘œì‹œ) -->
        <section class="card mb-lg" id="themeSection">
          <h2 class="text-lg font-semibold mb-md">ğŸ¨ í…Œë§ˆ ì„¤ì •</h2>
          <p class="text-secondary text-sm mb-md">ë¡œì»¬ ì €ì¥ìœ¼ë¡œ ë¡œê·¸ì¸ ì—†ì´ë„ ìœ ì§€ë©ë‹ˆë‹¤</p>
          
          <div class="theme-options">
            <label class="theme-option">
              <input type="radio" name="theme" value="system" id="themeSystem">
              <span class="theme-option-content">
                <span class="theme-option-icon">ğŸ’»</span>
                <span class="theme-option-label">ì‹œìŠ¤í…œ</span>
              </span>
            </label>
            <label class="theme-option">
              <input type="radio" name="theme" value="light" id="themeLight">
              <span class="theme-option-content">
                <span class="theme-option-icon">â˜€ï¸</span>
                <span class="theme-option-label">ë¼ì´íŠ¸</span>
              </span>
            </label>
            <label class="theme-option">
              <input type="radio" name="theme" value="dark" id="themeDark">
              <span class="theme-option-content">
                <span class="theme-option-icon">ğŸŒ™</span>
                <span class="theme-option-label">ë‹¤í¬</span>
              </span>
            </label>
          </div>
        </section>

        <!-- ì„¤ì • í¼ -->
        <div class="settings-content hidden" id="settingsContent">
          <!-- ë¡œê·¸ì¸ ì •ë³´ -->
          <section class="card mb-lg">
            <h2 class="text-lg font-semibold mb-md">ğŸ“§ ë¡œê·¸ì¸ ì •ë³´</h2>
            <p class="text-secondary" id="userEmail">-</p>
          </section>

          <!-- í‘œì‹œ ì´ë¦„ ì„¤ì • -->
          <section class="card mb-lg">
            <h2 class="text-lg font-semibold mb-md">ğŸ‘¤ í‘œì‹œ ì´ë¦„ ì„¤ì •</h2>
            
            <div class="form-group">
              <label class="flex items-center gap-sm mb-md">
                <input type="radio" name="nameType" value="google" id="useGoogleName">
                <span>êµ¬ê¸€ ê³„ì •ëª… ì‚¬ìš©</span>
              </label>
              <p class="text-secondary text-sm ml-xl" id="googleNamePreview">-</p>
            </div>

            <div class="form-group">
              <label class="flex items-center gap-sm mb-sm">
                <input type="radio" name="nameType" value="custom" id="useCustomName">
                <span>ìµëª… ë³„ëª… ì‚¬ìš©</span>
              </label>
              <input 
                type="text" 
                class="form-input mt-sm" 
                id="customNickname"
                placeholder="ë³„ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (2~12ì)"
                maxlength="12"
                disabled
              >
            </div>

            <p class="text-warning text-sm mt-md">
              âš ï¸ ëª¨ë“  ëª¨ì„ì— ì¼ê´„ ì ìš©ë©ë‹ˆë‹¤
            </p>

            <button class="btn btn-primary mt-lg" id="saveSettingsBtn">
              ì €ì¥í•˜ê¸°
            </button>
          </section>

          <!-- íšŒì› íƒˆí‡´ -->
          <section class="card">
            <h2 class="text-lg font-semibold mb-md text-danger">ğŸšª íšŒì› íƒˆí‡´</h2>
            <p class="text-secondary text-sm mb-md">
              íƒˆí‡´í•˜ë©´ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </p>
            <button class="btn btn-danger btn-sm" id="deleteAccountBtn">
              íƒˆí‡´í•˜ê¸°
            </button>
          </section>
        </div>

        <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœ -->
        <div class="card text-center hidden" id="notLoggedIn">
          <div class="empty-state-icon">ğŸ”’</div>
          <h3 class="empty-state-title">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
          <p class="empty-state-description">
            ì„¤ì •ì„ ë³€ê²½í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.
          </p>
          <button class="btn btn-primary mt-lg" id="loginBtn">
            ë¡œê·¸ì¸í•˜ê¸°
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- íƒˆí‡´ í™•ì¸ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">âš ï¸ ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
        <button class="modal-close" id="closeDeleteModal">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="4" x2="16" y2="16"></line>
            <line x1="16" y1="4" x2="4" y2="16"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="mb-md">íƒˆí‡´ ì‹œ ë‹¤ìŒ ì •ë³´ê°€ ì²˜ë¦¬ë©ë‹ˆë‹¤:</p>
        <ul class="text-sm text-secondary" style="list-style: disc; margin-left: 1.5rem;">
          <li>ì‘ë‹µ ê¸°ë¡ì€ ìµëª…ìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤</li>
          <li>ë“±ë¡í•œ ì§ˆë¬¸ì€ ìœ ì§€ë©ë‹ˆë‹¤</li>
          <li>ìƒì„±í•œ ëª¨ì„ì´ ìˆìœ¼ë©´ íƒˆí‡´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>
        </ul>
        <div class="form-group mt-lg">
          <label class="form-label">í™•ì¸ì„ ìœ„í•´ "íƒˆí‡´í•˜ê¸°"ë¥¼ ì…ë ¥í•˜ì„¸ìš”</label>
          <input 
            type="text" 
            class="form-input" 
            id="deleteConfirmInput"
            placeholder="íƒˆí‡´í•˜ê¸°"
          >
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelDeleteBtn">ì·¨ì†Œ</button>
        <button class="btn btn-danger" id="confirmDeleteBtn" disabled>íƒˆí‡´</button>
      </div>
    </div>
  </div>

  <!-- í…Œë§ˆ ì˜µì…˜ ìŠ¤íƒ€ì¼ -->
  <style>
    .theme-options {
      display: flex;
      gap: var(--spacing-md);
    }
    
    .theme-option {
      flex: 1;
      cursor: pointer;
    }
    
    .theme-option input {
      display: none;
    }
    
    .theme-option-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-lg);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      transition: all var(--transition-fast);
    }
    
    .theme-option input:checked + .theme-option-content {
      border-color: var(--color-accent);
      background-color: rgba(0, 113, 227, 0.05);
    }
    
    .theme-option:hover .theme-option-content {
      border-color: var(--color-accent);
    }
    
    .theme-option-icon {
      font-size: 1.5rem;
    }
    
    .theme-option-label {
      font-size: var(--font-size-sm);
      font-weight: 500;
    }
    
    @media (max-width: 480px) {
      .theme-options {
        flex-direction: column;
      }
    }
  </style>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { initHeader } from '/js/components/Header.js';
    import { checkSession, redirectToGoogleLogin } from '/js/utils/auth.js';
    import { userAPI } from '/js/services/api.js';
    import { toastSuccess, toastError } from '/js/components/Toast.js';
    import { setButtonLoading } from '/js/components/Loading.js';
    import { getTheme, setTheme } from '/js/utils/theme.js';

    let currentUser = null;

    async function init() {
      await initHeader();
      
      // í…Œë§ˆ ì„¤ì • ì´ˆê¸°í™” (ë¡œê·¸ì¸ ì—†ì´ë„ ë™ì‘)
      initThemeSettings();
      
      const user = await checkSession();
      
      const loadingState = document.getElementById('loadingState');
      const settingsContent = document.getElementById('settingsContent');
      const notLoggedIn = document.getElementById('notLoggedIn');
      
      loadingState.classList.add('hidden');
      
      if (!user) {
        notLoggedIn.classList.remove('hidden');
        document.getElementById('loginBtn').addEventListener('click', () => {
          redirectToGoogleLogin(window.GOOGLE_CLIENT_ID || '');
        });
        return;
      }
      
      currentUser = user;
      settingsContent.classList.remove('hidden');
      renderSettings(user);
      bindEvents();
    }
    
    function initThemeSettings() {
      const currentTheme = getTheme();
      
      // í˜„ì¬ í…Œë§ˆì— í•´ë‹¹í•˜ëŠ” ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ
      const themeRadio = document.querySelector(`input[name="theme"][value="${currentTheme}"]`);
      if (themeRadio) {
        themeRadio.checked = true;
      }
      
      // í…Œë§ˆ ë³€ê²½ ì´ë²¤íŠ¸
      document.querySelectorAll('input[name="theme"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          setTheme(e.target.value);
          // í—¤ë” ìƒˆë¡œê³ ì¹¨
          initHeader();
        });
      });
    }

    function renderSettings(user) {
      document.getElementById('userEmail').textContent = user.email;
      document.getElementById('googleNamePreview').textContent = `(${user.displayName})`;
      
      const useGoogleName = document.getElementById('useGoogleName');
      const useCustomName = document.getElementById('useCustomName');
      const customNickname = document.getElementById('customNickname');
      
      if (user.useNickname) {
        useCustomName.checked = true;
        customNickname.disabled = false;
        customNickname.value = user.customNickname || '';
      } else {
        useGoogleName.checked = true;
        customNickname.disabled = true;
      }
    }

    function bindEvents() {
      const useGoogleName = document.getElementById('useGoogleName');
      const useCustomName = document.getElementById('useCustomName');
      const customNickname = document.getElementById('customNickname');
      
      // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½
      useGoogleName.addEventListener('change', () => {
        customNickname.disabled = true;
      });
      
      useCustomName.addEventListener('change', () => {
        customNickname.disabled = false;
        customNickname.focus();
      });
      
      // ì €ì¥ ë²„íŠ¼
      document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
      
      // íƒˆí‡´ ê´€ë ¨
      document.getElementById('deleteAccountBtn').addEventListener('click', () => {
        document.getElementById('deleteModal').classList.add('open');
      });
      
      document.getElementById('closeDeleteModal').addEventListener('click', closeDeleteModal);
      document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal);
      
      document.getElementById('deleteConfirmInput').addEventListener('input', (e) => {
        document.getElementById('confirmDeleteBtn').disabled = e.target.value !== 'íƒˆí‡´í•˜ê¸°';
      });
      
      document.getElementById('confirmDeleteBtn').addEventListener('click', deleteAccount);
    }

    async function saveSettings() {
      const useNickname = document.getElementById('useCustomName').checked;
      const customNickname = document.getElementById('customNickname').value.trim();
      
      if (useNickname && (customNickname.length < 2 || customNickname.length > 12)) {
        toastError('ë³„ëª…ì€ 2~12ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const btn = document.getElementById('saveSettingsBtn');
      setButtonLoading(btn, true);
      
      try {
        await userAPI.updateMe({
          useNickname,
          customNickname: useNickname ? customNickname : null,
        });
        
        toastSuccess('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // í—¤ë” ìƒˆë¡œê³ ì¹¨
        await initHeader();
        
      } catch (error) {
        console.error('ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
        toastError(error.message || 'ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        setButtonLoading(btn, false);
      }
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('open');
      document.getElementById('deleteConfirmInput').value = '';
      document.getElementById('confirmDeleteBtn').disabled = true;
    }

    async function deleteAccount() {
      const btn = document.getElementById('confirmDeleteBtn');
      setButtonLoading(btn, true);
      
      try {
        await userAPI.deleteMe();
        toastSuccess('íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        setTimeout(() => {
          window.location.href = '/index.html';
        }, 1500);
      } catch (error) {
        console.error('íƒˆí‡´ ì‹¤íŒ¨:', error);
        toastError(error.message || 'íƒˆí‡´ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        setButtonLoading(btn, false);
      }
    }

    init();
  </script>
</body>
</html>
