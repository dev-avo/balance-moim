<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì„ ì´ˆëŒ€ - ë°¸ëŸ°ìŠ¤ ëª¨ì„</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header" id="header"></header>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <main class="page">
    <div class="container">
      <div class="page-content text-center">
        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingState" class="p-xl">
          <div class="loading-spinner"></div>
          <p class="text-secondary mt-md">ì´ˆëŒ€ ì •ë³´ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</p>
        </div>

        <!-- ì´ˆëŒ€ ì •ë³´ -->
        <div class="card hidden" id="inviteContent">
          <div class="text-4xl mb-lg">ğŸ‘¥</div>
          <h1 class="text-2xl font-bold mb-md" id="groupName"></h1>
          <p class="text-secondary mb-xl" id="groupDescription"></p>
          
          <div class="text-sm text-secondary mb-xl">
            <span id="memberCount">0</span>ëª…ì˜ ë©¤ë²„ê°€ í™œë™ ì¤‘
          </div>

          <button class="btn btn-primary btn-lg" id="joinBtn">
            ëª¨ì„ ì°¸ì—¬í•˜ê¸°
          </button>
        </div>

        <!-- ë¡œê·¸ì¸ í•„ìš” -->
        <div class="card hidden" id="loginRequired">
          <div class="text-4xl mb-lg">ğŸ”’</div>
          <h2 class="text-xl font-bold mb-md">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
          <p class="text-secondary mb-xl">
            ëª¨ì„ì— ì°¸ì—¬í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.
          </p>
          <button class="btn btn-primary btn-lg" id="inviteLoginBtn">
            ë¡œê·¸ì¸í•˜ê¸°
          </button>
        </div>

        <!-- ì—ëŸ¬ ìƒíƒœ -->
        <div class="card hidden" id="errorState">
          <div class="text-4xl mb-lg">ğŸ˜¢</div>
          <h2 class="text-xl font-bold mb-md" id="errorTitle">ì´ˆëŒ€ ë§í¬ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</h2>
          <p class="text-secondary mb-xl" id="errorMessage">
            ë§í¬ê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤.
          </p>
          <a href="/index.html" class="btn btn-secondary">
            í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { initHeader } from '/js/components/Header.js';
    import { checkSession, redirectToGoogleLogin, getGoogleClientId } from '/js/utils/auth.js';
    import { groupAPI } from '/js/services/api.js';
    import { toastSuccess, toastError } from '/js/components/Toast.js';
    import { setButtonLoading } from '/js/components/Loading.js';

    let inviteCode = null;
    let inviteInfo = null;

    async function init() {
      await initHeader();
      
      // URLì—ì„œ ì´ˆëŒ€ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      const params = new URLSearchParams(window.location.search);
      inviteCode = params.get('code');
      
      if (!inviteCode) {
        showError('ì´ˆëŒ€ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤', 'ì˜¬ë°”ë¥¸ ì´ˆëŒ€ ë§í¬ë¡œ ì ‘ì†í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¯¸ë¦¬ ì„¤ì •
      document.getElementById('inviteLoginBtn').addEventListener('click', handleLogin);
      
      // ì´ˆëŒ€ ì •ë³´ ë¡œë“œ
      await loadInviteInfo();
    }

    async function handleLogin() {
      try {
        // ë¡œê·¸ì¸ í›„ ëŒì•„ì˜¬ URL ì €ì¥
        sessionStorage.setItem('invite_redirect', window.location.href);
        const clientId = await getGoogleClientId();
        if (clientId) {
          redirectToGoogleLogin(clientId);
        } else {
          toastError('ë¡œê·¸ì¸ ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('ë¡œê·¸ì¸ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        toastError('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function loadInviteInfo() {
      const loadingState = document.getElementById('loadingState');
      
      try {
        const response = await groupAPI.getInviteInfo(inviteCode);
        inviteInfo = response.data;
        
        loadingState.classList.add('hidden');
        
        // ì‚¬ìš©ì í™•ì¸
        const user = await checkSession();
        
        if (!user) {
          // ë¡œê·¸ì¸ í•„ìš”
          document.getElementById('loginRequired').classList.remove('hidden');
          return;
        }
        
        // ì´ˆëŒ€ ì •ë³´ í‘œì‹œ
        renderInviteInfo(inviteInfo);
        
      } catch (error) {
        console.error('ì´ˆëŒ€ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        loadingState.classList.add('hidden');
        
        if (error.status === 404) {
          showError('ì´ˆëŒ€ ë§í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'ë§í¬ê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else if (error.status === 410) {
          showError('ì´ˆëŒ€ ë§í¬ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'ìƒˆë¡œìš´ ì´ˆëŒ€ ë§í¬ë¥¼ ìš”ì²­í•´ì£¼ì„¸ìš”.');
        } else {
          showError('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', error.message);
        }
      }
    }

    function renderInviteInfo(info) {
      document.getElementById('groupName').textContent = info.groupName;
      document.getElementById('groupDescription').textContent = info.groupDescription || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤';
      document.getElementById('memberCount').textContent = info.memberCount || 0;
      
      document.getElementById('inviteContent').classList.remove('hidden');
      
      // ì°¸ì—¬ ë²„íŠ¼
      document.getElementById('joinBtn').addEventListener('click', joinGroup);
    }

    async function joinGroup() {
      const btn = document.getElementById('joinBtn');
      setButtonLoading(btn, true);
      
      try {
        await groupAPI.join(inviteCode);
        toastSuccess('ëª¨ì„ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!');
        
        setTimeout(() => {
          window.location.href = `/groups/detail.html?id=${inviteInfo.groupId}`;
        }, 1000);
        
      } catch (error) {
        console.error('ëª¨ì„ ì°¸ì—¬ ì‹¤íŒ¨:', error);
        
        if (error.message?.includes('ì´ë¯¸ ì°¸ì—¬')) {
          toastSuccess('ì´ë¯¸ ì°¸ì—¬í•œ ëª¨ì„ì…ë‹ˆë‹¤.');
          setTimeout(() => {
            window.location.href = `/groups/detail.html?id=${inviteInfo.groupId}`;
          }, 1000);
        } else {
          toastError(error.message || 'ëª¨ì„ ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          setButtonLoading(btn, false);
        }
      }
    }

    function showError(title, message) {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorTitle').textContent = title;
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorState').classList.remove('hidden');
    }

    init();
  </script>
</body>
</html>
